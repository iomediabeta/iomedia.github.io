<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Github Page</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" type="text/css" href="assets/lib/perfect-scrollbar/css/perfect-scrollbar.min.css" />
  <link rel="stylesheet" type="text/css" href="assets/lib/material-design-icons/css/material-design-iconic-font.min.css" />
  <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  <link rel="stylesheet" type="text/css" href="assets/lib/datetimepicker/css/bootstrap-datetimepicker.min.css" />
  <link rel="stylesheet" type="text/css" href="assets/lib/datatable2/css/dataTables.bootstrap.min.css" />
  <link rel="stylesheet" href="assets/css/style.css" type="text/css" />
</head>

<body>
  <div class="be-wrapper be-nosidebar-left">
    <nav class="navbar navbar-default navbar-fixed-top be-top-header">
      <div class="container-fluid">
        <div id="be-navbar-collapse" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li><a href="#">Home</a></li>
            <li><a href="#">Page 1</a></li>
            <li><a href="#">Page 2</a></li>
          </ul>
        </div>
      </div>
    </nav>
    <div class="be-content">
      <div class="main-content container-fluid">
        <div class="row">
          <div class="col-sm-12">
            <div class="panel panel-default panel-table">
              <div class="panel-heading">Báo cáo
                <div class="tools">
                  <span class="icon mdi mdi-more-vert"></span></div>
              </div>
              <div class="panel-body">
                <div class="row dropdown-showcase" style="padding: 0 5px">
                  <div class="col-sm-2">
                    <div class="input-group input-group-sm" style="margin-top: 5px">
                      <span class="input-group-addon">Giới hạn</span>
                      <input id="in-limit" type="text" class="form-control" value="50">
                    </div>
                  </div>

                  <div class="col-sm-2">
                    <div class="input-group input-group-sm" style="margin-top: 5px">
                      <span class="input-group-addon">Số dòng</span>
                      <input id="in-page-length" type="text" class="form-control" value="8">
                    </div>
                  </div>

                  <div class="col-sm-2">
                    <div class="input-group input-group-sm">
                      <div data-min-view="2" data-date-format="dd/mm/yyyy" class="input-group date datetimepicker">
                        <input id="in-from-day" size="16" type="text" value="" class="form-control" placeholder="Từ ngày"><span
                          class="input-group-addon btn btn-primary"><i class="icon-th mdi mdi-calendar"></i></span>
                      </div>
                    </div>
                  </div>

                  <div class="col-sm-2">
                    <div class="input-group input-group-sm">
                      <div data-min-view="2" data-date-format="dd/mm/yyyy" class="input-group date datetimepicker">
                        <input id="in-to-day" size="16" type="text" value="" class="form-control" placeholder="Đến ngày"><span
                          class="input-group-addon btn btn-primary"><i class="icon-th mdi mdi-calendar"></i></span>
                      </div>
                    </div>
                  </div>

                  <div class="col-sm-2">
                    <input id="" type="text" class="form-control" style="margin-top: 5px" placeholder="Lọc">
                  </div>

                  <div class="col-sm-2">
                    <button id="btn-update" class="btn btn-primary hover" style="margin-top: 5px; height: 38px; width: 100%;"><i
                        class="icon icon-left mdi mdi-cloud-download"></i>
                      Cập nhật</button>
                  </div>

                </div>
                <table id="table-mlab" class="table table-striped table-hover table-fw-widget">
                  <thead>
                    <tr>
                      <th>Bộ IO</th>
                      <th>Thời gian</th>
                      <th>Cột 1</th>
                      <th>Cột 2</th>
                      <th>Cột 3</th>
                      <th>Cột 4</th>
                      <th>Cột 5</th>
                    </tr>
                  </thead>
                  <tbody id="mlab-row">

                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  </div>
  <script src="assets/lib/jquery/jquery.min.js" type="text/javascript"></script>
  <script src="assets/lib/bootstrap/dist/js/bootstrap.min.js" type="text/javascript"></script>
  <script src="assets/js/main.min.js"></script>
  <script src="assets/lib/datatable2/js/jquery.dataTables.min.js" type="text/javascript"></script>
  <script src="assets/lib/datatable2/js/dataTables.bootstrap.min.js" type="text/javascript"></script>
  <script src="assets/lib/datetimepicker/js/bootstrap-datetimepicker.min.js" type="text/javascript"></script>
  <script src="assets/js/app-tables-datatables.js" type="text/javascript"></script>
  <script type="text/javascript">
    $(document).ready(function () {
      // Kết nối dữ liệu mlab
      let api = "rT_GFFPSlEq7vFifcx-4KOJvOuH2W_nO";
      let database = "vsyscali1";
      let collection = "trash";
      let limit = "50";
      let query = "";

      let mlab = function () {
        return `https://api.mlab.com/api/1/databases/${database}/collections/${collection}?apiKey=${api}&l=${limit}&q=${query}`;
      };

      function convertDate(datetime) {
        const regex = /^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2}).(\d{3})Z$/;
        const subst = `$3/$2/$1 $4:$5:$6`;
        return datetime != "" ? datetime.replace(regex, subst) : datetime;
      }

      function getData() {
        $.get(mlab(), (data) => {
          data.forEach(d => {
            tb.fnAddData([d.id, convertDate(d.t.$date), d.c1, d.c2, d.c3, d.c4, d.c5]);
          });
        });
      }

      var tb = $("#table-mlab").dataTable({
        pageLength: 8,
        dom: "<'row be-datatable-body'<'col-sm-12'tr>>" +
          "<'row be-datatable-footer'<'col-sm-5'i><'col-sm-7'p>>"
      });

      $(".datetimepicker").datetimepicker({
        autoclose: true,
        componentIcon: '.mdi.mdi-calendar',
        navIcons: {
          rightIcon: 'mdi mdi-chevron-right',
          leftIcon: 'mdi mdi-chevron-left'
        }
      });

      $.get(mlab(), (data) => {
        $.extend(true, $.fn.dataTable.defaults, {
          dom:
            "<'row be-datatable-header'<'col-sm-6'l><'col-sm-6'f>>" +
            "<'row be-datatable-body'<'col-sm-12'tr>>" +
            "<'row be-datatable-footer'<'col-sm-5'i><'col-sm-7'p>>"
        });

        data.forEach(d => {
          tb.fnAddData([d.id, convertDate(d.t.$date), d.c1, d.c2, d.c3, d.c4, d.c5]);
        });
      });

      $("#in-limit").keydown((e) => {
        if (e.keyCode == 13) {
          limit = $("#in-limit").val();
          //console.log(limit);
          if (!isNaN(limit)) {
            tb.fnClearTable();
            getData();
          }
          else {
            alert("Giới hạn phải là số");
          }
        }
      });

      $("#in-page-length").keydown((e) => {
        if (e.keyCode == 13) {
          limit = $("#in-page-length").val();
          let a = $("#table-mlab").DataTable();

          if (limit == "") {
            a.page.len(-1).draw();
          }
          else if (!isNaN(limit)) {
            let p = Number.parseInt(limit);
            a.page.len(p).draw();
          }
          else {
            alert("Số trang phải là số");
          }
        }
      });

      $("#btn-update").click(() => {
        const regex = /^(\d{2})\/(\d{2})\/(\d{4})$/;
        const subst = `$3-$2-$1`;
        let dayFrom = $("#in-from-day").val().replace(regex, subst);
        let dayTo = $("#in-to-day").val().replace(regex, subst);

        limit = $("#in-limit").val();

        if (dayFrom != "" && dayTo != "") {
          query = `{"t":{"$gt":{"$date":"${dayFrom}T00:00:00.000Z"},"$lt":{"$date":"${dayTo}T23:59:00.000Z"}}}`;
        }
        else if (dayFrom == "") {
          query = `{"t":{"$lt":{"$date":"${dayTo}T23:59:00.000Z"}}}`;
        }
        else {
          query = `{"t":{"$gt":{"$date":"${dayFrom}T00:00:00.000Z"}}}`;
        }
        console.log(query);

        tb.fnClearTable();
        getData();
      });

    });
  </script>
</body>

</html>